<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Public+Sans%3Awght%40400%3B500%3B700%3B900"
    />    <title>タズネル - チャット</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />
    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <div class="main-container">
      <div class="layout-container flex flex-col">        <header class="header">
          <div class="header-logo">
            <div>
              <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M24 4H6V17.3333V30.6667H24V44H42V30.6667V17.3333H24V4Z" fill="currentColor"></path>
              </svg>
            </div>
            <a href="index.html">タズネル</a>
          </div>
          
          <!-- ハンバーガーメニューボタン（モバイル用） -->
          <button class="hamburger-btn" id="hamburgerBtn">
            <span></span>
            <span></span>
            <span></span>
          </button>
          
          <!-- ナビゲーション -->
          <div class="header-nav" id="headerNav">
            <a href="#">ダッシュボード</a>
            <a href="#">検索</a>
            <a href="index.html">チャット</a>
            <a href="#">プロフィール</a>
          </div>
        </header>        <!-- メイン画面：LINEスタイルの画面切り替え -->
        <div class="main-content">
          <!-- 画面1: トーク一覧画面 -->
          <div class="talk-list-screen" id="talkListScreen">
            <div class="talk-list-container">
              <!-- 自分の名前入力 -->
              <div class="user-setup" id="userSetup">                <div class="setup-header">
                  <h2>タズネル へようこそ</h2>
                  <p>あなたの名前を入力してチャットを開始しましょう</p>
                </div>
                <div class="setup-form">
                  <input
                    type="text"
                    id="uname"
                    placeholder="あなたの名前を入力"
                    class="user-input"
                  />
                  <button id="startChatBtn" class="start-chat-btn">チャット開始</button>
                </div>
              </div>
              
              <!-- トーク一覧 -->
              <div class="talk-list" id="talkList" style="display: none;">
                <!-- ユーザー検索 -->
                <div class="search-container">
                  <div class="search-box">
                    <div class="search-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                        <path
                          d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"
                        ></path>
                      </svg>
                    </div>
                    <input
                      id="userSearch"
                      placeholder="ユーザーを検索"
                      class="search-input"
                    />
                  </div>
                </div>

                <!-- ユーザー一覧 -->
                <div id="userList" class="user-list">
                  <!-- ユーザーが動的に追加される -->
                </div>
              </div>
            </div>
          </div>

          <!-- 画面2: 個別チャット画面 -->
          <div class="chat-screen hidden" id="chatScreen">
            <!-- チャットヘッダー -->
            <div class="chat-screen-header">
              <button class="back-btn" id="backBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
                  <path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path>
                </svg>
              </button>
              <div class="chat-partner-info">
                <div class="chat-partner-avatar" id="chatPartnerAvatar"></div>
                <div class="chat-partner-details">
                  <h3 id="chatPartnerName" class="chat-partner-name">ユーザー名</h3>
                  <p id="chatPartnerStatus" class="chat-partner-status">オンライン</p>
                </div>
              </div>
              <div class="chat-actions">
                <button class="action-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
                    <path d="M128,80a48,48,0,1,0,48,48A48.05,48.05,0,0,0,128,80Zm0,80a32,32,0,1,1,32-32A32,32,0,0,1,128,160ZM176,16H80A64.07,64.07,0,0,0,16,80v96a64.07,64.07,0,0,0,64,64h96a64.07,64.07,0,0,0,64-64V80A64.07,64.07,0,0,0,176,16Zm48,160a48.05,48.05,0,0,1-48,48H80a48.05,48.05,0,0,1-48-48V80A48.05,48.05,0,0,1,80,32h96a48.05,48.05,0,0,1,48,48Z"></path>
                  </svg>
                </button>
              </div>
            </div>

            <!-- チャット表示エリア -->
            <div id="output" class="chat-messages">
              <!-- メッセージが動的に追加される -->
            </div>

            <!-- メッセージ入力エリア -->
            <div class="message-input-area" id="messageInputArea">
              <div class="input-container">
                <button class="attachment-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
                    <path d="M209.66,122.34a8,8,0,0,1,0,11.32l-82.05,82a56,56,0,0,1-79.2-79.21L147.67,35.73a40,40,0,1,1,56.61,56.55L105,193A24,24,0,1,1,71,159L154.3,76.68a8,8,0,1,1,11.4,11.22L82.39,170.24a8,8,0,1,0,11.27,11.31L192.93,81A24,24,0,1,0,159,47L59.76,147.68a40,40,0,1,0,56.53,56.62l82.06-82A8,8,0,0,1,209.66,122.34Z"></path>
                  </svg>
                </button>
                <input
                  id="text"
                  placeholder="メッセージを入力"
                  class="message-input"
                />                <button id="send" class="send-button">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#2c3e50" viewBox="0 0 256 256">
                    <path d="M231.4,44.34s0,0,0,0h0a8.32,8.32,0,0,0-8.81-1.74L33.81,108.67a16,16,0,0,0,2.59,29.8L80,152l-15.52,78.51a16,16,0,0,0,26.84,13.26L128,208l42.68,35.77a16,16,0,0,0,26.84-13.26L182,152l43.6-13.53a16,16,0,0,0,2.59-29.8L239.41,42.6A8.32,8.32,0,0,0,231.4,44.34ZM62,126.87,186.25,75.25,102.87,158.63Zm94,102.26L118.37,153.13l83.38-83.38Z"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
      <script>
      // ハンバーガーメニューの動作
      document.addEventListener('DOMContentLoaded', function() {
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const headerNav = document.getElementById('headerNav');
        
        hamburgerBtn.addEventListener('click', function() {
          headerNav.classList.toggle('active');
          hamburgerBtn.classList.toggle('active');
        });
        
        // メニュー項目クリック時にメニューを閉じる（モバイル）
        const navLinks = headerNav.querySelectorAll('a');
        navLinks.forEach(link => {
          link.addEventListener('click', function() {
            if (window.innerWidth <= 768) {
              headerNav.classList.remove('active');
              hamburgerBtn.classList.remove('active');
            }
          });
        });
        
        // ウィンドウリサイズ時の処理
        window.addEventListener('resize', function() {
          if (window.innerWidth > 768) {
            headerNav.classList.remove('active');
            hamburgerBtn.classList.remove('active');
          }
        });
      });

      // 画面切り替え機能
      function showTalkList() {
        document.getElementById('talkListScreen').classList.remove('hidden');
        document.getElementById('chatScreen').classList.add('hidden');
      }

      function showChatScreen() {
        document.getElementById('talkListScreen').classList.add('hidden');
        document.getElementById('chatScreen').classList.remove('hidden');
      }

      // チャット開始ボタンの処理
      document.addEventListener('DOMContentLoaded', function() {
        const startChatBtn = document.getElementById('startChatBtn');
        const userSetup = document.getElementById('userSetup');
        const talkList = document.getElementById('talkList');
        const backBtn = document.getElementById('backBtn');

        startChatBtn.addEventListener('click', function() {
          const userName = document.getElementById('uname').value.trim();
          if (userName) {
            userSetup.style.display = 'none';
            talkList.style.display = 'block';
            // Firebase にユーザー登録処理をここで実行
            registerUser(userName);
          } else {
            alert('名前を入力してください');
          }
        });

        // 戻るボタンの処理
        backBtn.addEventListener('click', function() {
          showTalkList();
        });
      });
    </script>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        onChildAdded,
        remove,
        onChildRemoved,
        onValue,
        off,
      } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";
      
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "",
        authDomain: "",
        databaseURL: "",
        projectId: "",
        storageBucket: "",
        messagingSenderId: "",
        appId: "",
      };
      
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const usersRef = ref(db, "users");
      let chatRoomRef = null;
      let currentChatListener = null;

      // 現在のユーザー情報
      let currentUser = {
        id: localStorage.getItem("chatUserId") || generateUserId(),
        name: "",
        sessionId: localStorage.getItem("chatUserSession") || generateSessionId(),
        lastSeen: Date.now()
      };
      
      localStorage.setItem("chatUserId", currentUser.id);
      localStorage.setItem("chatUserSession", currentUser.sessionId);

      let currentChatPartner = null;
      let allUsers = {};

      function generateUserId() {
        return "user_" + Math.random().toString(36).substr(2, 9) + "_" + Date.now();
      }

      function generateSessionId() {
        return "session_" + Math.random().toString(36).substr(2, 9) + "_" + Date.now();
      }

      // ユーザーアバターを生成する関数
      function generateAvatar(username, userId) {
        const colors = [
          "#ff6b6b", "#4ecdc4", "#45b7d1", "#96ceb4", 
          "#feca57", "#ff9ff3", "#54a0ff", "#5f27cd"
        ];
        const colorIndex = userId
          .split("")
          .reduce((acc, char) => acc + char.charCodeAt(0), 0) % colors.length;
        const backgroundColor = colors[colorIndex];
        const initial = username.charAt(0).toUpperCase();

        return `<div class="avatar-circle" style="background-color: ${backgroundColor}; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; flex-shrink: 0;">${initial}</div>`;
      }

      // チャットルームIDを生成（ユーザーID順でソート）
      function generateChatRoomId(userId1, userId2) {
        return [userId1, userId2].sort().join("_");
      }      // ユーザー登録関数をグローバルに定義
      window.registerUser = function(userName) {
        currentUser.name = userName;
        updateUserPresence();
        
        // 定期的にプレゼンス更新
        setInterval(updateUserPresence, 15000);
      };

      // ユーザー名更新時の処理
      $("#uname").on("input", function() {
        const name = $(this).val().trim();
        if (name) {
          currentUser.name = name;
          updateUserPresence();
        }
      });

      // ユーザーのオンライン状態を更新
      function updateUserPresence() {
        if (currentUser.name.trim()) {
          const userRef = ref(db, `users/${currentUser.id}`);
          set(userRef, {
            name: currentUser.name,
            lastSeen: Date.now(),
            sessionId: currentUser.sessionId
          });
        }
      }

      // ユーザー一覧を監視
      onValue(usersRef, (snapshot) => {
        const users = snapshot.val() || {};
        allUsers = users;
        updateUserList(users);
      });      // ユーザー一覧を更新
      function updateUserList(users) {
        const searchQuery = $("#userSearch").val().toLowerCase().trim();
        const $userList = $("#userList");
        $userList.empty();

        Object.keys(users).forEach(userId => {
          if (userId === currentUser.id) return; // 自分は表示しない
          
          const user = users[userId];
          
          // 検索フィルター: 名前で検索（ひらがな・カタカナ・英数字対応）
          if (searchQuery && !user.name.toLowerCase().includes(searchQuery)) {
            return; // 検索クエリにマッチしない場合はスキップ
          }
          
          const isOnline = (Date.now() - user.lastSeen) < 30000; // 30秒以内はオンライン
          const avatar = generateAvatar(user.name, userId);
          
          // 検索語をハイライト
          let displayName = user.name;
          if (searchQuery) {
            const regex = new RegExp(`(${searchQuery})`, 'gi');
            displayName = user.name.replace(regex, '<mark style="background-color: #fffacd; padding: 1px 2px; border-radius: 2px;">$1</mark>');
          }
          
          const $userItem = $(`
            <div class="talk-item" data-user-id="${userId}">
              ${avatar}
              <div class="talk-info">
                <div class="talk-header">
                  <p class="talk-name">${displayName}</p>
                  <p class="talk-time">${formatLastSeen(user.lastSeen)}</p>
                </div>
                <div class="talk-preview">
                  <p class="talk-message">タップしてチャットを開始</p>
                  ${isOnline ? '<div class="online-badge"></div>' : ''}
                </div>
              </div>
            </div>
          `);

          $userItem.on("click", () => selectChatPartnerAndNavigate(userId, user.name));
          $userList.append($userItem);
        });
        
        // 検索結果が空の場合の表示
        if ($userList.children().length === 0) {
          if (searchQuery) {
            $userList.append(`
              <div style="padding: 20px; text-align: center; color: #999;">
                「${searchQuery}」に一致するユーザーが見つかりません
              </div>
            `);
          } else if (Object.keys(users).length <= 1) { // 自分以外のユーザーがいない場合
            $userList.append(`
              <div style="padding: 20px; text-align: center; color: #999;">
                他のユーザーがオンラインになるまでお待ちください
              </div>
            `);
          }
        }
      }// 検索機能の実装
      let searchTimeout;
      $("#userSearch").on("input", function() {
        // デバウンス: 300ms 待機してから検索実行
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          updateUserList(allUsers);
        }, 300);
      });      // 検索ボックスのクリア機能
      $("#userSearch").on("keydown", function(e) {
        if (e.key === "Escape") {
          $(this).val("");
          updateUserList(allUsers);
        }
      });

      // チャット相手を選択して画面遷移
      function selectChatPartnerAndNavigate(userId, userName) {
        currentChatPartner = { id: userId, name: userName };
        
        // チャット画面のヘッダー情報を更新
        document.getElementById('chatPartnerName').textContent = userName;
        document.getElementById('chatPartnerAvatar').innerHTML = generateAvatar(userName, userId);
        
        // チャットルームを設定
        setupChatRoom(userId);
        
        // 画面切り替え
        showChatScreen();
      }

      // チャットルームの設定
      function setupChatRoom(partnerId) {
        // 既存のリスナーをクリア
        if (currentChatListener && chatRoomRef) {
          off(chatRoomRef, "child_added", currentChatListener);
        }
        
        // チャットルームIDを生成
        const chatRoomId = generateChatRoomId(currentUser.id, partnerId);
        chatRoomRef = ref(db, `chats/${chatRoomId}`);
        
        // メッセージエリアをクリア
        $("#output").empty();
        
        // 新しいリスナーを設定
        currentChatListener = onChildAdded(chatRoomRef, (snapshot) => {
          const data = snapshot.val();
          displayMessage(data);
        });
      }

      // メッセージを表示する関数
      function displayMessage(data) {
        const messageContainer = document.createElement('div');
        messageContainer.className = 'message-container';
        
        const isSent = data.senderId === currentUser.id;
        messageContainer.classList.add(isSent ? 'sent' : 'received');
        
        const messageTime = new Date(data.timestamp || Date.now());
        const timeString = messageTime.toLocaleTimeString('ja-JP', {
          hour: '2-digit',
          minute: '2-digit'
        });
        
        let messageHtml;
        
        if (isSent) {
          // 送信メッセージ
          messageHtml = `
            <div class="message-row sent">
              <div class="message-content sent">
                <p class="message-sender sent">あなた</p>
                <div class="message-bubble sent">
                  <p class="message-text">${escapeHtml(data.text)}</p>
                </div>
                <p class="message-time sent">${timeString}</p>
              </div>
            </div>
          `;
        } else {
          // 受信メッセージ
          const avatar = generateAvatar(data.senderName, data.senderId);
          messageHtml = `
            <div class="message-row received">
              ${avatar}
              <div class="message-content received">
                <p class="message-sender received">${escapeHtml(data.senderName)}</p>
                <div class="message-bubble received">
                  <p class="message-text">${escapeHtml(data.text)}</p>
                </div>
                <p class="message-time received">${timeString}</p>
              </div>
            </div>
          `;
        }
        
        messageContainer.innerHTML = messageHtml;
        
        const outputElement = document.getElementById('output');
        outputElement.appendChild(messageContainer);
        
        // 最下部にスクロール
        outputElement.scrollTop = outputElement.scrollHeight;
      }

      // HTMLエスケープ関数
      function escapeHtml(text) {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
      }

      // 最終アクセス時間のフォーマット
      function formatLastSeen(timestamp) {
        const now = Date.now();
        const diff = now - timestamp;
        
        if (diff < 30000) return 'オンライン';
        if (diff < 60000) return '1分前';
        if (diff < 3600000) return Math.floor(diff / 60000) + '分前';
        if (diff < 86400000) return Math.floor(diff / 3600000) + '時間前';
        
        const date = new Date(timestamp);
        return date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
      }

      // メッセージ送信機能
      let isSending = false;

      function sendMessage() {
        if (isSending || !currentChatPartner) return;
        
        const textElement = document.getElementById('text');
        const messageText = textElement.value.trim();
        
        if (!messageText) return;
        
        isSending = true;
        const sendButton = document.getElementById('send');
        sendButton.disabled = true;
        
        const messageData = {
          text: messageText,
          senderId: currentUser.id,
          senderName: currentUser.name,
          timestamp: Date.now()
        };
        
        push(chatRoomRef, messageData)
          .then(() => {
            textElement.value = '';
            textElement.focus();
          })
          .catch((error) => {
            console.error('メッセージ送信エラー:', error);
            alert('メッセージの送信に失敗しました。');
          })
          .finally(() => {
            isSending = false;
            sendButton.disabled = false;
          });
      }

      // 送信ボタンのイベントリスナー
      document.getElementById('send').addEventListener('click', sendMessage);

      // Enterキーでメッセージ送信
      document.getElementById('text').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // グローバル関数として定義
      window.selectChatPartnerAndNavigate = selectChatPartnerAndNavigate;
    </script>
  </body>
</html>
